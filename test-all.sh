#!/bin/bash
# test-all.sh - –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ obf-minify-build

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ obf-minify-build..."

# –û—á–∏—Å—Ç–∫–∞
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–±–æ—Ä–æ–∫..."
rm -rf build dist test-custom

# –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ (Makefile)
echo ""
echo "‚úÖ –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ (Makefile)"
npx obf-minify-build
if [ $? -eq 0 ]; then
    echo "‚úÖ –ë–∞–∑–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ"
    if [ -d "build" ] && [ -f "build/html/index.html" ]; then
        echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ build/ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
    else
        echo "‚ùå –°—Ç—Ä—É–∫—Ç—É—Ä–∞ build/ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
        exit 1
    fi
else
    echo "‚ùå –ë–∞–∑–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å"
    exit 1
fi

# –¢–µ—Å—Ç 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—É—Ç–∏
echo ""
echo "‚úÖ –¢–µ—Å—Ç 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—É—Ç–∏"
npx obf-minify-build --src src --out dist
if [ $? -eq 0 ]; then
    echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—É—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç"
    if [ -d "dist" ] && [ -f "dist/html/index.html" ]; then
        echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ dist/ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
    else
        echo "‚ùå –°—Ç—Ä—É–∫—Ç—É—Ä–∞ dist/ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
        exit 1
    fi
else
    echo "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—É—Ç–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç"
    exit 1
fi

# –¢–µ—Å—Ç 3: Node.js —Å–±–æ—Ä–∫–∞
echo ""
echo "‚úÖ –¢–µ—Å—Ç 3: Node.js —Å–±–æ—Ä–∫–∞"
npx obf-minify-build --no-make
if [ $? -eq 0 ]; then
    echo "‚úÖ Node.js —Å–±–æ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå Node.js —Å–±–æ—Ä–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    exit 1
fi

# –¢–µ—Å—Ç 4: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
echo ""
echo "‚úÖ –¢–µ—Å—Ç 4: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
npx obf-minify-build --src src --out test-custom --no-make
if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç"
    if [ -d "test-custom" ] && [ -f "test-custom/html/index.html" ]; then
        echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ test-custom/ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
    else
        echo "‚ùå –°—Ç—Ä—É–∫—Ç—É—Ä–∞ test-custom/ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
        exit 1
    fi
else
    echo "‚ùå –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç"
    exit 1
fi

# –¢–µ—Å—Ç 5: –°–ø—Ä–∞–≤–∫–∞
echo ""
echo "‚úÖ –¢–µ—Å—Ç 5: –°–ø—Ä–∞–≤–∫–∞"
npx obf-minify-build --help > /dev/null
if [ $? -eq 0 ]; then
    echo "‚úÖ –°–ø—Ä–∞–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå –°–ø—Ä–∞–≤–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏
echo "  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ CSS..."
if grep -q "user-select:none" build/css/protection.*.css; then
    echo "  ‚úÖ CSS –º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω"
else
    echo "  ‚ùå CSS –Ω–µ –º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏
echo "  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏ JS..."
if grep -q "function _0x" build/js/protection.*.js; then
    echo "  ‚úÖ JS –æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω"
else
    echo "  ‚ùå JS –Ω–µ –æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
echo "  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤..."
if ls build/css/protection.*.css | grep -q "\."; then
    echo "  ‚úÖ CSS —Ñ–∞–π–ª—ã —Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã"
else
    echo "  ‚ùå CSS —Ñ–∞–π–ª—ã –Ω–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã"
    exit 1
fi

if ls build/js/protection.*.js | grep -q "\."; then
    echo "  ‚úÖ JS —Ñ–∞–π–ª—ã —Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã"
else
    echo "  ‚ùå JS —Ñ–∞–π–ª—ã –Ω–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫
echo "  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫..."
if grep -q "protection\.[a-f0-9]*" build/html/index.html; then
    echo "  ‚úÖ –°—Å—ã–ª–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "  ‚ùå –°—Å—ã–ª–∫–∏ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
    exit 1
fi

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
echo ""
echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±–æ—Ä–∫–∏:"
echo "  –ò—Å—Ö–æ–¥–Ω–∏–∫–∏: $(du -sh src/ | cut -f1)"
echo "  –°–±–æ—Ä–∫–∞: $(du -sh build/ | cut -f1)"
echo "  –§–∞–π–ª–æ–≤ –≤ src/: $(find src/ -type f | wc -l)"
echo "  –§–∞–π–ª–æ–≤ –≤ build/: $(find build/ -type f | wc -l)"

echo ""
echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
echo "‚úÖ obf-minify-build —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
